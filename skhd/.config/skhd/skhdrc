# via https://gist.github.com/pkazmier/213d9dce6b1ea313eaf0a17b017c2b08
# Modified from https://github.com/alyssais configuration.
#
# The following configuration heavily leverages modal keymaps to minimize the
# pollution of global keybindings. In addition, the modal keymaps facilitate
# the consistent use of the same keybindings across different modes. For
# example, this configuration uses 'h', 'l', 'j', and 'k' to represent west,
# east, south, and north when: changing focus, warping windows, resizing
# windows, swapping windows, and moving floating windows. Those four keys are
# mapped differently depending on the current mode to provide a consistent user
# experience.
# 
# Six different modes are provided in this configuration in addition to the
# default mode. The modes are tailored to their respective operations. Common
# operations are generally available without the need of any modifier keys.
# When modifier keys are used, they are for infrequent actions or size related
# actions. Entry into the modal system is via hyper - space, which enters FOCUS
# mode. From there, any of the other modes can be activated with a single
# keypress.
#
# A high-level overview of the bindings can be found in bindings.txt



:: default  : yabai -m config active_window_border_color 0x00775759
# @todo indicate mode with color or some other way
:: app    @                                                          # Launch apps
:: sys    @                                                          # System control mode
:: focus  @ : yabai -m config active_window_border_color 0xffe06c75  # Focus window, desktop, monitors
:: grid   @ : yabai -m config active_window_border_color 0xff56b6c2  # Floating window layout
:: swap   @ : yabai -m config active_window_border_color 0xffc678dd  # Swap windows
:: warp   @ : yabai -m config active_window_border_color 0xffe5c07b  # Warp and send to desktop/monitors
:: warpnf @ : yabai -m config active_window_border_color 0xffd19a66  # Same, but don't follow focus
:: resize @ : yabai -m config active_window_border_color 0xff98c379  # Resize window operations
# @TODO: use a different color -- this one is copied from warpnf
:: stack  @ : yabai -m config active_window_border_color 0xffd19a66  # Stack windows


# ========================================
# APP LAUNCHER mode
# ========================================

default < hyper - a ; app
app     < hyper - a ; default
app     < escape    ; default

# _e_macs -- create a new frame
app     < e : emacsclient -cn; \
              skhd -k 'escape'

# _f_irefox -- new window
app     < f : /Applications/Firefox.app/Contents/MacOS/firefox \
              -new-window \
              -foreground ; \
              skhd -k 'escape'

# _t_erminal (Kitty) -- new os-window
app     < t : kitty @ --to unix:/tmp/kitty-socket \
              new-window --window-type os ; \
              skhd -k 'escape'


# ========================================
# SYSTEM mode
# ========================================

default < hyper - s ; sys
sys     < hyper - s ; default
sys     < escape    ; default

# Toggle dark mode.
# @TODO: avoid a hard-coded path -- can an envar be used? `$DOTS` didn't work
sys     < d : ~/.dots/scripts/toggle-dark-mode.sh ; \
              skhd -k 'escape'


# ========================================
# HYPER-SPACE / YABAI modes
# ========================================

# HYPER-SPACE is the global hotkey to toggle in/out of modal mode. Entry is
# always to FOCUS mode. Getting out of any mode can also be done with ESCAPE.
default                                 < hyper - space            ; focus
focus, grid, swap, warp, warpnf, resize, stack < hyper - space     ; default
grid, swap, warp, warpnf, resize, stack < escape                   ; focus
focus < escape                                                     ; default

# Restart yabai
default < hyper - y : launchctl kickstart -k "gui/${UID}/homebrew.mxcl.yabai"

# Once in FOCUS mode (or any other mode other than default), you can switch
# modes with single keystroke. (mnemonic: letter corresponds to first letter of
# mode name, with exception of warpnf, which is a variant invoked with shift)
 
# Disable FOCUS mode switching since it's easy to get back to and so we
# can free up a keybinding.
# focus, grid, swap, warp, warpnf, resize < f                 ; focus

focus, grid, swap, warp, warpnf, resize < g                 ; grid 
focus, grid, swap, warp, warpnf, resize < r                 ; resize
focus, grid, swap, warp, warpnf, resize < s                 ; swap
focus, grid, swap, warp, warpnf, resize < shift - w         ; warpnf
focus, grid, swap, warp, warpnf, resize < t                 ; stack
focus, grid, swap, warp, warpnf, resize < w                 ; warp

# The following keybindings are available in all modes.
focus, grid, swap, warp, warpnf, resize < b                 : yabai -m space --balance
focus, grid, swap, warp, warpnf, resize < f                 : yabai -m window --toggle float           # mnemonic: _f_loat
focus, grid, swap, warp, warpnf, resize < i                 : yabai -m window --toggle split           
focus, grid, swap, warp, warpnf, resize < m                 : yabai -m window --toggle zoom-fullscreen # mnemonic: monocle 
focus, grid, swap, warp, warpnf, resize < o                 : yabai -m space --toggle padding          # mnemonic: _o_ffset
focus, grid, swap, warp, warpnf, resize < p                 : yabai -m window --toggle zoom-parent     # mnemonic: _p_arent
focus, grid, swap, warp, warpnf, resize < q                 : yabai -m window --close                  # mnemonic: _q_uit
focus, grid, swap, warp, warpnf, resize < shift - space     : yabai -m space --rotate 270
focus, grid, swap, warp, warpnf, resize < space             : yabai -m space --rotate 90
focus, grid, swap, warp, warpnf, resize < x                 : yabai -m space --mirror x-axis           # horizontal
focus, grid, swap, warp, warpnf, resize < y                 : yabai -m space --mirror y-axis           # vertical


# 
# YABAI :: FOCUS mode
# ========================================
# Change focus using standard vi directional keys. Enter changes focus to the
# biggest window. You'll see this theme repeated over and over again.
#
# FOCUS mode does a lot of heavy lifting, inferring some "do what I mean" behavior.
#
# 
# If a window doesn't exist in the specified direction, then fall back to
# focusing the next available display in that direction. If there's no available
# display, then, as a last resort, try paging through a window stack.
# 

# UP/DOWN           :
# 1. window north/south
# 2. display north/south
# 3. stack prev/next
# 4. stack last/first (cycle)
focus           < k : yabai -m window --focus north || yabai -m display --focus north \
                              || yabai -m window --focus stack.prev || yabai -m window --focus stack.last
focus           < j : yabai -m window --focus south || yabai -m display --focus south \
                              || yabai -m window --focus stack.next || yabai -m window --focus stack.first

# LEFT/RIGHT
# 1. window east/west
# 2. dispay east/west
# 3. space next/prev
focus           < h : yabai -m window --focus west || yabai -m display --focus west || yabai -m space --focus prev
focus           < l : yabai -m window --focus east || yabai -m display --focus east || yabai -m space --focus next

# Change the window focused in the current stack, cycling around to the beginning/end.
focus           < shift - n : yabai -m window --focus stack.prev || yabai -m window --focus stack.last
focus           < n         : yabai -m window --focus stack.next || yabai -m window --focus stack.first

focus           < return    : yabai -m window --focus biggest

# Change the space focus using numbers corresponding to space or cycle
# through the spaces using tab and shift - tab combination. You'll see this
# pattern repeated when we get WARP mode as well. The non-modified keys will
# warp to a space, and prefixing with ctrl will warp to a monitor. Again, the
# goal was to aim for consistency.
focus           < 1           : yabai -m space --focus 1
focus           < 2           : yabai -m space --focus 2
focus           < 3           : yabai -m space --focus 3
focus           < tab         : yabai -m space --focus next
focus           < shift - tab : yabai -m space --focus prev
focus           < shift - h   : yabai -m space --focus prev
focus           < shift - l   : yabai -m space --focus next

# Prefix the above with ctrl to change the monitor focus using numbers
# corresponding to monitor or cycle through the monitors using tab and shift -
# tab combination. 
focus           < ctrl - 1           : yabai -m display --focus 1
focus           < ctrl - 2           : yabai -m display --focus 2
focus           < ctrl - 3           : yabai -m display --focus 3
focus           < ctrl - tab         : yabai -m display --focus next
focus           < ctrl + shift - tab : yabai -m display --focus prev
focus           < ctrl - h           : yabai -m display --focus west
focus           < ctrl - l           : yabai -m display --focus east

# Change the layout mode of a desktop to one of the three supported modes.
focus           < shift - b : yabai -m space --layout bsp     # mnemonic: _b_sp
focus           < shift - s : yabai -m space --layout stack   # mnemonic: _s_tack
focus           < shift - f : yabai -m space --layout float   # mnemonic: _f_loat


#
# YABAI :: GRID mode
# ========================================
# Grid mode bindings are to resize and place floating windows on your desktop
# in well known positions.
# 

# The standard non-modified keys are used to resize the window to the top-half,
# bottom-half, right-half, left-half, and center of screen respectively.
grid            < k                 : yabai -m window --grid 2:1:0:0:1:1
grid            < j                 : yabai -m window --grid 2:1:0:1:1:1
grid            < l                 : yabai -m window --grid 1:2:1:0:1:1
grid            < h                 : yabai -m window --grid 1:2:0:0:1:1
grid            < return            : yabai -m window --grid 6:6:1:1:4:4

# Prefix the above with shift modifier to resize a bit smaller: top-third,
# bottom-third, left-third, right-third, and smaller center.
grid            < shift - k         : yabai -m window --grid 3:1:0:0:1:1
grid            < shift - j         : yabai -m window --grid 3:1:0:2:1:1
grid            < shift - l         : yabai -m window --grid 1:3:2:0:1:1
grid            < shift - h         : yabai -m window --grid 1:3:0:0:1:1
grid            < shift - return    : yabai -m window --grid 4:4:1:1:2:2

# Prefix with ctrl to resize even smaller and place in corners or center.
grid            < ctrl - k           : yabai -m window --grid 5:5:4:4:1:1
grid            < ctrl - j           : yabai -m window --grid 5:5:0:4:1:1
grid            < ctrl - l           : yabai -m window --grid 5:5:4:0:1:1
grid            < ctrl - h           : yabai -m window --grid 5:5:0:0:1:1
grid            < ctrl - return      : yabai -m window --grid 6:6:2:2:2:2

#
# YABAI :: SWAP mode
# ========================================
# 

# Swap windows using standard vi directional keys. 
swap            < k                 : yabai -m window --swap north
swap            < j                 : yabai -m window --swap south
swap            < l                 : yabai -m window --swap east
swap            < h                 : yabai -m window --swap west
swap            < return            : yabai -m window --swap biggest


#
# YABAI :: WARP mode
# ========================================
# 

# Warp windows using standard vi directional keys. These bindings are the same
# whether you are in WARP or WARPNF mode.
warp, warpnf    < k                 : yabai -m window --warp north
warp, warpnf    < j                 : yabai -m window --warp south
warp, warpnf    < return            : yabai -m window --warp biggest

# WARP and WARPNF modes handle east/west differenttly
# @TODO: Handle fallback to display and then space -- but 'following' relies on a sequence
# @TODO: Query for additional window in the specified direction before attempting to warp to the next space
# warp      < l : yabai -m window --warp east || yabai -m window --space next; yabai -m space --focus next
# warp      < h : yabai -m window --warp west || yabai -m window --space prev; yabai -m space --focus prev
warp, warpnf    < l : yabai -m window --warp east
warp, warpnf    < h : yabai -m window --warp west

# Warp window to monitor and follow.
warp            < ctrl - 1           : yabai -m window --display 1; yabai -m display --focus 1
warp            < ctrl - 2           : yabai -m window --display 2; yabai -m display --focus 2
warp            < ctrl - 3           : yabai -m window --display 3; yabai -m display --focus 3
warp            < ctrl - tab         : yabai -m window --display next; yabai -m display --focus next
warp            < ctrl + shift - tab : yabai -m window --display prev; yabai -m display --focus prev
warp            < ctrl - l           : yabai -m window --display next; yabai -m display --focus next
warp            < ctrl - h           : yabai -m window --display prev; yabai -m display --focus prev

# Warp window to space and follow.
warp            < 1                : yabai -m window --space 1; yabai -m space --focus 1
warp            < 2                : yabai -m window --space 2; yabai -m space --focus 2
warp            < 3                : yabai -m window --space 3; yabai -m space --focus 3
warp            < tab              : yabai -m window --space next; yabai -m space --focus next
warp            < shift - tab      : yabai -m window --space prev; yabai -m space --focus prev
warp            < shift - l        : yabai -m window --space next; yabai -m space --focus next
warp            < shift - h        : yabai -m window --space prev; yabai -m space --focus prev

# Warp window to space, but do NOT follow.
warpnf          < 1                 : yabai -m window --space 1
warpnf          < 2                 : yabai -m window --space 2
warpnf          < 3                 : yabai -m window --space 3
warpnf          < tab               : yabai -m window --space next
warpnf          < shift - tab       : yabai -m window --space prev

# Prefix with ctrl to warp window to monitor, but do NOT follow.
warpnf          < ctrl - 1           : yabai -m window --display 1
warpnf          < ctrl - 2           : yabai -m window --display 2
warpnf          < ctrl - 3           : yabai -m window --display 3
warpnf          < ctrl - tab         : yabai -m window --display next
warpnf          < ctrl + shift - tab : yabai -m window --display prev


#
# YABAI :: RESIZE mode
# ========================================
# 
 
# Increase size of window using standard vi directional keys.
resize          < k                 : yabai -m window --resize top:0:-48
resize          < j                 : yabai -m window --resize bottom:0:48 
resize          < l                 : yabai -m window --resize right:48:0  
resize          < h                 : yabai -m window --resize left:-48:0 

# Prefix the above with shift to decrease size of window using standard vi
# directional keys.
resize          < shift - k         : yabai -m window --resize top:0:48
resize          < shift - j         : yabai -m window --resize bottom:0:-48 
resize          < shift - l         : yabai -m window --resize right:-48:0  
resize          < shift - h         : yabai -m window --resize left:48:0 

# STACK mode -- for moving windows amongst stacks.
stack    < k                 : yabai -m window --stack north
stack    < j                 : yabai -m window --stack south
stack    < l                 : yabai -m window --stack east
stack    < h                 : yabai -m window --stack west
stack    < return            : yabai -m window --stack biggest
# @TODO: command doesn't seem to work, even when running in shell
# stack    < i                 : hs -c 'stackline.config:toggle("appearance.showIcons")'


#
# YABAI :: errata
# ========================================
# 

# Change the next insertion point to be something other than the default (left)
# using standard vi directional keys with the ctrl modifier. In addition, to
# make the next window a floating window, we bind ctrl - t (using same mnemonic
# as above). As these operations are intended for the next window that is
# opened, we exit FOCUS mode immediately. Finally, to cancel any of these
# "next" window operations, we bind ctrl - return. 
#
# @todo update these
#
# focus           < ctrl - k           : chunkc tiling::window --use-insertion-point north; qes -k "hyper - space"
# focus           < ctrl - j           : chunkc tiling::window --use-insertion-point south; qes -k "hyper - space"
# focus           < ctrl - l           : chunkc tiling::window --use-insertion-point east; qes -k "hyper - space"
# focus           < ctrl - h           : chunkc tiling::window --use-insertion-point west; qes -k "hyper - space"
# focus           < ctrl - t           : chunkc set window_float_next 1; qes -k "hyper - space"
# focus           < ctrl - return      : chunkc tiling::window --use-insertion-point cancel; chunkc set window_float_next 0; qes -k "hyper - space"
